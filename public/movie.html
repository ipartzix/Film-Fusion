<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FilmFusion</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="p-6 bg-slate-900 text-white">
    <!-- Title -->
    <div class="text-center mb-8">
      <h1 class="text-5xl font-extrabold text-purple-400">FilmFusion</h1>
      <p class="text-gray-400 italic">
        Not just recommendations, your perfect movie matchmaker üíúüé•
      </p>
    </div>

    <!-- Input -->
    <div class="flex flex-col md:flex-row items-center justify-center gap-4 mb-12">
      <input
        id="movie-input"
        type="text"
        placeholder="Enter a movie..."
        class="flex-1 w-full p-4 rounded-xl bg-gray-800 text-white"
      />
      <button
        id="ai-recommend-btn"
        class="px-8 py-4 rounded-xl font-semibold bg-gradient-to-r from-cyan-500 to-purple-600 shadow-lg"
      >
        Recommend
      </button>
    </div>

    <!-- Loading -->
    <div id="loading" class="hidden text-purple-400 text-center mb-6">
      ‚ú® AI is thinking...
    </div>

    <!-- Hero -->
    <div id="hero" class="hidden mb-12 relative h-60 rounded-2xl overflow-hidden">
      <div class="absolute bottom-6 left-6">
        <h2 id="hero-title" class="text-3xl font-bold"></h2>
        <p id="hero-genres" class="text-gray-300"></p>
        <span id="hero-rating" class="bg-black bg-opacity-70 px-2 py-1 rounded text-yellow-400"></span>
      </div>
    </div>

    <!-- Recommendations -->
    <h2 class="text-2xl font-bold mb-4">Recommended Movies</h2>
    <div id="recommendations" class="flex gap-4 overflow-x-auto"></div>

    <script>
      const movieInput = document.getElementById("movie-input");
      const recommendBtn = document.getElementById("ai-recommend-btn");
      const loading = document.getElementById("loading");
      const recommendations = document.getElementById("recommendations");
      const hero = document.getElementById("hero");
      const heroTitle = document.getElementById("hero-title");
      const heroGenres = document.getElementById("hero-genres");
      const heroRating = document.getElementById("hero-rating");

      async function getAIRecommendations() {
        const movieTitle = movieInput.value.trim();
        if (!movieTitle) return;

        recommendations.innerHTML = "";
        loading.classList.remove("hidden");
        hero.classList.add("hidden");

        try {
          // 1. Ask Gemini
          const aiRes = await fetch("/api/movie", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query: movieTitle }),
          });
          const aiMovies = await aiRes.json();

          let firstMovieSet = false;

          for (const m of aiMovies) {
            // 2. Get TMDB details
            const searchRes = await fetch(`/api/search?title=${encodeURIComponent(m.title)}`);
            const movie = await searchRes.json();

            if (!movie) continue;

            const poster = movie.poster_path
              ? `https://image.tmdb.org/t/p/w500${movie.poster_path}`
              : "https://via.placeholder.com/300x450?text=No+Poster";
            const rating = movie.vote_average ? movie.vote_average.toFixed(1) : "N/A";
            const genreNames = (movie.genre_names || []).join(", ");

            if (!firstMovieSet) {
              hero.style.backgroundImage = `url(https://image.tmdb.org/t/p/original${movie.backdrop_path})`;
              heroTitle.textContent = movie.title;
              heroGenres.textContent = genreNames;
              heroRating.textContent = `‚≠ê ${rating}/10`;
              hero.classList.remove("hidden");
              firstMovieSet = true;
            }

            const card = document.createElement("div");
            card.className = "min-w-[200px] max-w-[220px] bg-slate-800 rounded-xl p-3";
            card.innerHTML = `
              <img src="${poster}" class="w-full h-72 object-cover rounded-lg mb-2">
              <h3 class="font-bold">${movie.title}</h3>
              <p class="text-sm text-gray-400">${genreNames}</p>
              <span class="text-yellow-400">‚≠ê ${rating}/10</span>
            `;
            recommendations.appendChild(card);
          }
        } catch (err) {
          console.error(err);
          recommendations.innerHTML = `<p class="text-red-400">‚ùå Something went wrong.</p>`;
        } finally {
          loading.classList.add("hidden");
        }
      }

      recommendBtn.addEventListener("click", getAIRecommendations);
      movieInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") getAIRecommendations();
      });
    </script>
  </body>
</html>
